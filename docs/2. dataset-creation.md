# Dataset Creation

Once raw data is fetched, it must be transformed into analysis-ready datasets.

## 1. Daily Maximum Temperature (Ground Truth)

Convert hourly observations into reliable daily Tmax values, filtering out days with insufficient data coverage.

### Build Script
Use `scripts/build_daily_tmax.py`.

```bash
python scripts/build_daily_tmax.py --station KLGA --timezone America/New_York
```

**Arguments:**
- `--station`: Station ID.
- `--timezone`: Local timezone for daily aggregation (e.g., `America/New_York`).
- `--min-coverage`: Minimum hours of data required to accept a day (default: 18).

**Output:**
- `data/clean/daily_tmax/<station>.parquet`

## 2. Training Features (Forecast + Truth)

For advanced evaluation or model training, we combine forecasts with ground truth and compute rolling error statistics (bias, RMSE) to use as features.

### Programmatic Build
Feature generation is currently handled via the `tempdata.features` module.

```python
import pandas as pd
from tempdata.features.build_train_daily_tmax import build_train_daily_tmax, write_train_daily_tmax

# Load data
forecast_df = pd.read_parquet("data/clean/forecasts/openmeteo/KLGA/combined.parquet")
truth_df = pd.read_parquet("data/clean/daily_tmax/KLGA.parquet")

# Build features
train_df = build_train_daily_tmax(
    forecast_df=forecast_df,
    truth_df=truth_df,
    min_coverage_hours=18
)

# Save
write_train_daily_tmax(train_df, "data/features/KLGA_train.parquet")
```

This dataset includes:
- `tmax_pred_f`: The raw forecast.
- `tmax_actual_f`: The observed ground truth.
- `residual`: Forecast error.
- `sin_doy` / `cos_doy`: Seasonality.
- `bias_7d`, `rmse_14d`, etc.: Rolling historical performance metrics specific to the lead time.
