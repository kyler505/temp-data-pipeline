# Data Acquisition

The pipeline ingests temperature data from three primary sources:
1. **NOAA ISD/GHCNh**: Historical observed temperature (ground truth).
2. **ERA5 Reanalysis**: Deep historical temperature records (model training/backfill).
3. **Open-Meteo**: Operational weather forecasts (evaluation target).

## 1. NOAA Observed Data (Ground Truth)

We use NOAA's Integrated Surface Database (ISD) and Global Historical Climatology Network hourly (GHCNh) data for ground truth.

### Fetching Hourly Data
Use `scripts/fetch_noaa_hourly.py` to download and process station data.

```bash
# Fetch data for LaGuardia (KLGA) from 2020 to 2024
python scripts/fetch_noaa_hourly.py --station KLGA --start 2020-01-01 --end 2024-01-01
```

**Arguments:**
- `--station`: USAF/WBAN station identifier (e.g., `KLGA`, `KNYC`).
- `--start`: Start date (YYYY-MM-DD).
- `--end`: End date (YYYY-MM-DD, exclusive).
- `--force`: Force re-download of raw CSVs.
- `--no-cache`: Do not save raw CSVs to cache.

**Output:**
- Parquet files in `data/clean/hourly_obs/<station>/`.

## 2. ERA5 Reanalysis (Historical Context)

ERA5 provides hourly temperature estimates back to 1940, useful for training models before high-quality forecast archives are available.

### Usage
ERA5 fetching is handled programmatically via the `tempdata.fetch.era5_hourly` module. You must have the `cdsapi` package installed and configured (`~/.cdsapirc`).

```python
from tempdata.fetch.era5_hourly import fetch_era5_hourly

written_files = fetch_era5_hourly(
    station_id="KLGA",
    start_date="2010-01-01",
    end_date="2020-01-01"
)
```

**Output:**
- Parquet files in `data/raw/era5/<station>/`.

## 3. Open-Meteo Forecasts (Target)

We fetch archived operational forecasts from Open-Meteo to evaluate prediction accuracy.

### Fetching Daily Tmax Forecasts
Use `scripts/fetch_openmeteo_daily_forecast.py`.

```bash
# Fetch 14-day forecasts for KLGA
python scripts/fetch_openmeteo_daily_forecast.py --station KLGA --forecast-days 14
```

**Arguments:**
- `--station`: Station ID (lat/lon resolved from `stations/stations.csv`).
- `--forecast-days`: Number of lead days to fetch (default: 14).
- `--write-raw`: Save raw JSON responses (debug).
- `--out-parquet`: Custom output directory (optional).

**Output:**
- Parquet files in `data/clean/forecasts/openmeteo/<station>/`.
